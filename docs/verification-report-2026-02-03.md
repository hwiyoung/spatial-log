# 3D 데이터 변환 파이프라인 검증 보고서

**작성일**: 2026-02-03

## 1. 검증 개요

Phase 9-10에서 구현된 3D 데이터 변환 파이프라인의 정상 작동 여부를 검증했습니다.

### 검증 항목

| 항목 | 결과 | 비고 |
|------|------|------|
| E57 좌표 추출 | ⚠️ 부분 성공 | 테스트 파일 좌표 불완전 |
| OBJ → 3D Tiles 변환 | ✅ 성공 | WGS84 좌표 정확 |
| OBJ 텍스처 포함 | ✅ 성공 | MTL/텍스처 정상 처리 |

---

## 2. E57 좌표 추출 검증

### 테스트 파일

- **파일명**: samyang_4326.e57
- **크기**: 152,392,704 bytes (약 145MB)
- **포인트 수**: 4,854,250

### PDAL 분석 결과

```json
{
  "bounds": {
    "minx": 0.000120404,
    "maxx": 0.000670364,
    "miny": 0.000209226,
    "maxy": 0.000942964,
    "minz": 35.4857,
    "maxz": 49.6012
  }
}
```

### 좌표계 감지 결과

- **is_geographic**: true (지리 좌표로 감지됨)
- **is_swapped**: true (좌표 축 뒤바뀜 패턴 감지)
- **감지된 중심**: 위도 42.54°, 경도 0.0004°

### 문제점

- X/Y 값이 경도 값이 아닌 상대적 차이값으로 저장됨
- 경도 정보가 누락되어 정확한 위치 표시 불가
- **제한사항**: E57 파일에 올바른 WGS84 좌표가 저장되어 있어야 함

### 좌표계 감지 로직 (converter.py)

```python
# 패턴 1: X/Y가 매우 작고 Z가 위도 범위 (좌표 축 뒤바뀜)
is_swapped_geo = (x_range < 1 and y_range < 1 and
                  20 <= minz <= 70 and 20 <= maxz <= 70)

# 패턴 2: 표준 지리 좌표 (-180~180, -90~90)
is_standard_geo = (-180 <= minx <= 180 and -180 <= maxx <= 180 and
                   -90 <= miny <= 90 and -90 <= maxy <= 90 and
                   x_range < 10 and y_range < 10)

# 패턴 3: 한국 TM 좌표계 (EPSG:5186, 5187 등)
is_korea_tm = (100000 <= minx <= 700000 and ...)
```

---

## 3. OBJ → 3D Tiles 변환 검증

### 테스트 파일

- **파일명**: samyang.obj
- **관련 파일**: samyang.mtl, samyang.jpg
- **정점 수**: 207,179

### 좌표계 감지 결과

```json
{
  "spatialInfo": {
    "epsg": 4326,
    "isGeographic": true,
    "bbox": {
      "minX": 127.057403,
      "maxX": 127.05761,
      "minY": 37.540269,
      "maxY": 37.540584,
      "minZ": 35.5339,
      "maxZ": 52.246422
    },
    "center": {
      "longitude": 127.05750649999999,
      "latitude": 37.5404265,
      "altitude": 43.890161
    }
  }
}
```

### 변환 결과

1. **WGS84 좌표 변환**: 경위도(도) → 로컬 미터 좌표로 정상 변환
2. **GLB 생성**: 23.2MB → 12.4MB로 압축 (46% 감소)
3. **3D Tiles tileset.json**: ECEF 좌표 정확히 계산

### tileset.json 분석

```json
{
  "root": {
    "transform": [
      -0.798, -0.603, 0, 0,
      -0.478, 0.633, 0.609, 0,
      -0.367, 0.486, -0.793, 0,
      -3051455.29, 4040972.99, 3865127.87, 1
    ]
  }
}
```

- **ECEF 좌표**: X=-3,051,455m, Y=4,040,973m, Z=3,865,128m
- **WGS84 변환**: 위도 37.54°, 경도 127.06° (서울 근처) ✅

---

## 4. OBJ 텍스처 변환 검증

### 변환 로그

```
mtl_references_found: ["samyang.mtl"]
mtl_file_copied: /var/lib/storage/.../samyang.mtl
texture_references_found: ["samyang.jpg"]
texture_file_copied: /var/lib/storage/.../samyang.jpg
```

### GLB 텍스처 포함 확인

```
MATERIALS:
┌───┬─────────┬──────────────────┐
│ # │ name    │ textures         │
├───┼─────────┼──────────────────┤
│ 0 │ samyang │ baseColorTexture │
└───┴─────────┴──────────────────┘

TEXTURES:
┌───┬─────────┬────────────┬────────────┬───────────┐
│ # │ name    │ mimeType   │ resolution │ size      │
├───┼─────────┼────────────┼────────────┼───────────┤
│ 0 │ samyang │ image/webp │ 2048x2048  │ 561.81 KB │
└───┴─────────┴────────────┴────────────┴───────────┘
```

### 결과

- MTL 파일에서 텍스처 참조 정상 파싱
- Supabase 스토리지에서 텍스처 파일 검색 및 복사 성공
- GLB에 텍스처 포함 (WebP 형식, 2048x2048)

---

## 5. 결론 및 권장사항

### 정상 작동하는 기능

1. **OBJ → GLB → 3D Tiles 변환 파이프라인**: 완전히 작동
2. **WGS84 좌표 감지 및 변환**: 정확한 ECEF 좌표 생성
3. **MTL/텍스처 처리**: 자동 검색 및 포함
4. **GLB 압축**: gltf-transform으로 46% 크기 감소

### 제한사항 (문서화 필요)

1. **E57 좌표계**: 파일에 올바른 WGS84 좌표가 저장되어 있어야 함
   - 해결 방안: 좌표계 선택 UI 추가 (Phase 11 예정)

2. **OBJ 관련 파일**: OBJ, MTL, 텍스처가 동일 시점에 업로드되어야 함
   - 이미 변환된 후 텍스처만 추가 업로드하면 재변환 필요

### 다음 단계

- [ ] 정상 좌표가 있는 E57 파일로 재검증
- [ ] GLTF/GLB → 3D Tiles 변환 구현 (Phase 11)
- [ ] 좌표계 선택 UI 추가 (Phase 11)
