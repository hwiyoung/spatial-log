# Deployment Workflow
# main 브랜치에 푸시될 때 개발 + 운영 환경 동시 배포

name: Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy-dev:
    name: Deploy Development
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd ${{ secrets.PROJECT_PATH || '/home/${{ secrets.SERVER_USER }}/spatial-log' }}

            # 최신 코드 가져오기
            git fetch origin main
            git checkout main
            git pull origin main

            # 개발 환경 빌드 및 배포
            docker compose down
            docker compose build --no-cache
            docker compose up -d

            # 오래된 이미지 정리
            docker image prune -f

            echo "Development deployment completed at $(date)"

      - name: Verify Development
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd ${{ secrets.PROJECT_PATH || '/home/${{ secrets.SERVER_USER }}/spatial-log' }}
            docker compose ps

            # 헬스 체크
            sleep 10
            curl -f http://localhost:5174 || echo "Warning: Frontend health check failed"
            curl -f http://localhost:8100/health || echo "Warning: API health check failed"
            curl -f http://localhost:8200/health || echo "Warning: Converter health check failed"

  deploy-prod:
    name: Deploy Production
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd ${{ secrets.PROJECT_PATH || '/home/${{ secrets.SERVER_USER }}/spatial-log' }}

            # 최신 코드 가져오기
            git fetch origin main
            git checkout main
            git pull origin main

            # 운영 환경 빌드 및 배포
            docker compose -f docker-compose.prod.yml --env-file .env.prod -p spatial-log-prod down
            docker compose -f docker-compose.prod.yml --env-file .env.prod -p spatial-log-prod build --no-cache
            docker compose -f docker-compose.prod.yml --env-file .env.prod -p spatial-log-prod up -d

            # 오래된 이미지 정리
            docker image prune -f

            echo "Production deployment completed at $(date)"

      - name: Verify Production
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd ${{ secrets.PROJECT_PATH || '/home/${{ secrets.SERVER_USER }}/spatial-log' }}
            docker compose -f docker-compose.prod.yml -p spatial-log-prod ps

            # 헬스 체크
            sleep 10
            curl -f http://localhost:8090 || echo "Warning: Frontend health check failed"
            curl -f http://localhost:8101/health || echo "Warning: API health check failed"
            curl -f http://localhost:8201/health || echo "Warning: Converter health check failed"

# ===========================================
# GitHub Secrets 설정 필요:
# ===========================================
# SERVER_HOST: 서버 IP 또는 도메인
# SERVER_USER: SSH 사용자명
# SERVER_SSH_KEY: SSH 개인키 (-----BEGIN OPENSSH PRIVATE KEY----- 포함)
# PROJECT_PATH: (선택) 프로젝트 경로, 기본값: /home/{SERVER_USER}/spatial-log
